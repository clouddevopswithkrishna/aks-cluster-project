trigger:
  - main

parameters:
  - name: environment
    displayName: Target Environment
    type: string
    default: dev
    values:
      - dev
      - test
      - prod


pool:
  vmImage: 'ubuntu-latest'

variables:
  serviceConnection: 'azure-connection-name'
  resourceGroup: 'terraform-state-rg'
  storageAccount: 'tfstateunique281012345'
  container: '${{ parameters.environment }}-tfstateunique12345'
  key: '${{ parameters.environment }}.terraform.tfstate'
  environment: ${{ parameters.environment }}
  # Destroy logic is now dynamic based on DESTROY_TRIGGER file
  destroyFlag: ''

stages:
  - stage: Validate
    displayName: 'Validation & Linting'
    jobs:
      - job: Lint
        displayName: 'Lint Code'
        steps:
          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: 'latest'

          - script: terraform fmt -check -recursive
            displayName: 'Terraform Format Check'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

      - job: Validate
        displayName: 'Validate Config'
        dependsOn: Lint
        steps:
          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: 'latest'

          - script: |
              terraform init -backend=false
              terraform validate
            workingDirectory: '$(System.DefaultWorkingDirectory)/environments/$(environment)'
            displayName: 'Terraform Validate'

  - stage: Plan
    displayName: 'Terraform Plan'
    dependsOn: Validate
    jobs:
      - job: Plan
        displayName: 'Plan Infrastructure'
        steps:
          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: 'latest'

          - script: |
              if [ -f "DESTROY_TRIGGER" ]; then
                echo "##vso[task.setvariable variable=destroyFlag]-destroy"
                echo "##vso[task.setvariable variable=isDestroy]true"
                echo "WARNING: Destroy Trigger Found!"
              else
                echo "##vso[task.setvariable variable=destroyFlag]"
                echo "##vso[task.setvariable variable=isDestroy]false"
              fi
            workingDirectory: '$(System.DefaultWorkingDirectory)/environments/$(environment)'
            displayName: 'Check Destroy Mode'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/environments/$(environment)'
              backendServiceArm: '$(serviceConnection)'
              backendAzureRmResourceGroupName: '$(resourceGroup)'
              backendAzureRmStorageAccountName: '$(storageAccount)'
              backendAzureRmContainerName: '$(container)'
              backendAzureRmKey: '$(key)'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(System.DefaultWorkingDirectory)/environments/$(environment)'
              commandOptions: '-out=tfplan $(destroyFlag)'
              environmentServiceNameAzureRM: '$(serviceConnection)'

          - script: |
              # Capture full human-readable plan
              PLAN_TEXT=$(terraform show -no-color tfplan)
              
              # Construct the display message
              DETAILS="Target Environment: $(environment)"
              DETAILS+=$'\n'
              
              if [ "$(isDestroy)" == "true" ]; then
                 DETAILS+="⚠️⚠️⚠️ WARNING: CLUSTER WILL BE DESTROYED ⚠️⚠️⚠️"
                 DETAILS+=$'\n'
                 DETAILS+="The DESTROY_TRIGGER file was found."
                 DETAILS+=$'\n'
              fi
              
              DETAILS+="Plan Details:"
              DETAILS+=$'\n'
              DETAILS+="$PLAN_TEXT"
              
              # Handle empty details (safety check)
              if [ -z "$PLAN_TEXT" ]; then
                DETAILS="Target Environment: $(environment)"
                DETAILS+=$'\n'
                DETAILS+="No changes detected or plan is empty."
              fi
              
              echo "Plan Details:"
              echo "$DETAILS"
               
              # Set variable for next stage. Encode newlines for ADO variable.
              DETAILS="${DETAILS//$'\n'/'%0A'}"
              echo "##vso[task.setvariable variable=PlanDetails;isOutput=true]$DETAILS"
            displayName: 'Analyze Plan'
            name: SetVars

          - publish: '$(System.DefaultWorkingDirectory)/environments/$(environment)/tfplan'
            artifact: tfplan
            displayName: 'Publish Plan Artifact'

  - stage: Review
    displayName: 'Manual Review'
    dependsOn: Plan
    jobs:
      - job: WaitForValidation
        displayName: 'Wait for External Validation'
        pool: server
        variables:
          PlanDetails: $[ stageDependencies.Plan.Plan.outputs['SetVars.PlanDetails'] ]
        steps:
          - task: ManualValidation@0
            timeoutInMinutes: 1440 # 1 day
            inputs:
              notifyUsers: |
                user@example.com
              instructions: |
                Please review the Terraform Plan for $(environment) environment.
                
                Changes Detected:
                $(PlanDetails)
                
                Check the Pipeline Logs for the full Plan output.
              onTimeout: 'reject'

  - stage: Apply
    displayName: 'Terraform Apply'
    dependsOn: Review
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - deployment: Apply
        displayName: 'Apply Infrastructure'
        environment: ${{ parameters.environment }}
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - download: current
                  artifact: tfplan
                  displayName: 'Download Plan Artifact'

                - task: TerraformInstaller@0
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: 'latest'

                - task: TerraformTaskV4@4
                  displayName: 'Terraform Init'
                  inputs:
                    provider: 'azurerm'
                    command: 'init'
                    workingDirectory: '$(System.DefaultWorkingDirectory)/environments/$(environment)'
                    backendServiceArm: '$(serviceConnection)'
                    backendAzureRmResourceGroupName: '$(resourceGroup)'
                    backendAzureRmStorageAccountName: '$(storageAccount)'
                    backendAzureRmContainerName: '$(container)'
                    backendAzureRmKey: '$(key)'

                - script: |
                    echo "Target Environment: $(environment)"
                    echo "Displaying Plan for Verification:"
                    terraform show -no-color $(Pipeline.Workspace)/tfplan/tfplan
                  displayName: 'Show Plan'
                  workingDirectory: '$(System.DefaultWorkingDirectory)/environments/$(environment)'

                - task: TerraformTaskV4@4
                  displayName: 'Terraform Apply'
                  inputs:
                    provider: 'azurerm'
                    command: 'apply'
                    workingDirectory: '$(System.DefaultWorkingDirectory)/environments/$(environment)'
                    commandOptions: '$(Pipeline.Workspace)/tfplan/tfplan'
                    environmentServiceNameAzureRM: '$(serviceConnection)'
